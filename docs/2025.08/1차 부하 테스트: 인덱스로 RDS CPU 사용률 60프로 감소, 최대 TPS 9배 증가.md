## 1차 부하 테스트: 인덱스로 RDS CPU 사용률 60% 감소, 최대 TPS 9배 증가

> ##### 2025.08.27 ~ 2025.08.28 (1일)

> ### 부하 테스트 환경
> 
> #### 테스트 대상
> 
> "배송 가능한 의뢰 조회"(목록)는 배송원이 의뢰를 수락할 때 반드시 사용하는 핵심 기능으로 **가장 요청이 많아 응답시간과 TPS가 중요**합니다.
> 
> #### 인스턴스 사양
> 
> - `AWS RDS db.t4g.micro` - MySQL Community × 1
> - `AWS EC2 t2.micro` - Ubuntu × 1
>
> #### DB에 저장된 데이터
> 
> - `order` 테이블 1,000만 건 (조회 대상: 100만 건(10%))
> - `user` 테이블: 20만 건 (1인 평균 `order` 50건)
> 
> #### k6 부하 테스트 시나리오
> 
> 스테이지
> 
> 1. 4분 동안 가상 사용자 **100명까지 증가**
> 2. 2분 동안 가상 사용자 **100명 유지**
> 
> 이터레이션
> 
> - 이터레이션마다 10회 요청
> - 요청마다 1초 sleep, 다음 요청에는 페이지네이션 파라미터를 20씩 증가
> - 이터레이션 종료 시 페이지네이션 파라미터는 0으로 초기화

### 문제

<!-- - 누가
- 어디서
  - AWS환경에서
- 언제
  - 부하테스트를 할때
- 왜
  - CPU사용률이 10%미만이지만 RDS는 높았음 TPS낮음

- 무엇을
  - user테이블 지갑주소에
- 어떻게
  - 인덱스 걸었음
- 성과
  - TPS 높아짐, RDS부하 낮춤 -->

부하 테스트 결과, **RDS CPU 사용률이 80%를 유지하며 병목이 발생**했습니다.

- `EC2 t2.micro` CPU 사용률 10%
- `RDS db.t4g.micro` **CPU 사용률 80%**
- **최대 25TPS**

#### EC2 CPU 사용률 (10% 미만)

![EC2 CPU 사용률 (10% 미만)](<1 RDS CPU 병목 발생/EC2 CPU 사용률.png>)

#### 개선 전: RDS CPU 사용률 (최대 80%)

![개선 전: RDS CPU 사용률 (최대 80%)](<1 RDS CPU 병목 발생/개선 전: RDS CPU 사용률 (최대 80).png>)

#### 개선 전: k6 부하 테스트 결과 (25TPS)

![개선 전: k6 부하 테스트 결과 (25TPS)](<1 RDS CPU 병목 발생/개선 전: k6 부하 테스트 결과 (25TPS).png>)

### 해결

처음에는 **RDS와 연동한 단위 테스트의 응답 시간이 100ms 미만으로 짧아 DB 부하가 적을 것이라 예상**했습니다. 하지만 `user.walletAddress`에 인덱스가 없어 **Full Table Scan이 발생했고, RDS CPU 사용률을 80%까지 높였습니다.**

`walletAddress`에 Unique 인덱스를 추가하여, **RDS CPU 사용률은 80% → 20%**로 낮추고 **최대 TPS는 25 → 245(약 9배)로 향상**되었습니다. 이 과정을 통해 **응답 시간만으로는 실제 CPU 사용률을 판단할 수 없다**는 것을 알게 되었습니다.

#### `EXPLAIN ANALYZE` 실행 계획 (인덱스 추가 전)

```log
-> Filter: (`user`.walletAddress = '...')  (cost=21216 rows=20421) (actual time=121..133 rows=1 loops=1)
    -> Table scan on user  (cost=21216 rows=204211) (actual time=0.0664..111 rows=200000 loops=1)
```

#### `EXPLAIN ANALYZE` 실행 계획 (인덱스 추가 후)

```log
-> Rows fetched before execution  (cost=0..0 rows=1) (actual time=74e-6..115e-6 rows=1 loops=1)
```

#### 개선 후: RDS CPU 사용률 (20% 미만)

![개선 후: RDS CPU 사용률 (20% 미만)](<1 RDS CPU 병목 해결/개선 후: RDS CPU 사용률 (20).png>)

#### 개선 후: k6 부하 테스트 결과 (245TPS)

![개선 후: k6 부하 테스트 결과 (245TPS)](<1 RDS CPU 병목 해결/개선 후: k6 부하 테스트 결과 (245TPS).png>)
