## 2차 부하 테스트: 로드밸런서로 병렬 EC2 인스턴스를 구성해 CPU 사용률 20% 감소, TPS 4배 증가

> ##### 2025.08.28 ~ 2025.08.28 (1일)

2차 부하 테스트는 [1차 부하 테스트](<1차 부하 테스트: 인덱스로 RDS CPU 사용률 60프로 감소, 최대 TPS 9배 증가.md#부하-테스트-환경>)보다 **가상 사용자를 100 → 1,000으로 늘렸습니다.**

> ### 부하 테스트 환경
> 
> #### 테스트 대상
> 
> "배송원이 배송 가능한 의뢰를 조회하는 기능"은 배송원이 의뢰인의 의뢰를 수락하기 위해 반드시 사용하는 서비스의 핵심 기능으로 **가장 요청이 많아 응답시간과 TPS가 중요**합니다.
> 
> #### 인스턴스 사양
> 
> - `AWS EC2 t2.micro` - Ubuntu
> - `AWS RDS db.t4g.micro` - MySQL Community
> 
> #### DB에 저장된 데이터
> 
> - order 테이블 1,000만 레코드 (10%는 배송 가능한 주문)
> - user 테이블 20만 레코드 (1명당 50주문)
> 
> ### k6 부하 테스트 시나리오
> 
> #### 스테이지
> 
> 1. 4분 동안 가상 사용자 **1,000명까지 증가**
> 2. 2분 동안 가상 사용자 **1,000명 유지**
> 
> #### 이러레이션
> 
> - 이러레이션마다 10회 요청
> - 요청마다 1초 sleep, 다음 요청에는 페이지네이션 파라미터를 20씩 증가
> - 이터레이션 종료 시 페이지네이션 파라미터는 0으로 초기화

### 문제

<!-- - 누가
- 어디서
  - AWS환경에서
- 언제
  - 부하테스트를 할때
- 왜
  - EC2 서버 인스턴스 사용률이 80% 이상인데 반해 RDS는 20%미만임

- 무엇을
  - ec2 서버 인스턴스를
- 어떻게
  - 6대까지 늘리고 로드벨런서를 연결해 부하를 분산시킨다.
- 성과
  - TPS 높아짐, ec2부하 낮춤, RDS 병목 발생 -->

1차 부하 테스트에서 RDS CPU 병목을 해결한 후, 이번에는 **EC2 서버 인스턴스에서 CPU 사용률 80% 이상을 유지하며 병목이 발생**했습니다.

#### 개선 전: EC2 CPU 사용률 (80% 유지)

![개선 전: EC2 CPU 사용률 (80% 유지)](<1 RDS CPU 병목 해결/EC2 CPU 사용률.png>)

### 해결

성능을 높이기 보다 AWS 프리 티어를 최대한 활용하기 위해 **t2.micro를 1 → 6대로 늘리고 로드밸런서로 부하를 분산**시켰습니다. 이 과정에서 **t2.micro CPU 사용률을 80% → 40~60%로**, **최대 TPS를 245 → 1,000으로 향상**시켰습니다.

**개선 후: EC2 CPU 사용률 (40~60%)**

![개선 후: EC2 CPU 사용률 (40~60%)](<2 RDS 커넥션 풀 병목 발생/개선 후: EC2 CPU 사용률 .png>)

**개선 전: k6 부하 테스트 결과 (245TPS)**

![개선 전: k6 부하 테스트 결과 (245TPS)](<1 RDS CPU 병목 해결/개선 후: k6 부하 테스트 결과 (245TPS).png>)

**개선 후: k6 부하 테스트 결과 (1000TPS)**

![개선 후: k6 부하 테스트 결과 (1000TPS)](<2 RDS 커넥션 풀 병목 발생/개선 후: k6 부하 테스트 결과 (1000TPS).png>)
