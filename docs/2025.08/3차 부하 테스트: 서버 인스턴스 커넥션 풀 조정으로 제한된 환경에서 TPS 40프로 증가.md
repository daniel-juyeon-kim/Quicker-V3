## 3차 부하 테스트: 서버 인스턴스 커넥션 풀 조정으로 제한된 환경에서 TPS 40% 증가

> ##### 2025.08.28 ~ 2025.08.30 (2일)

> ### 부하 테스트 환경
>
> <ins>**이전 부하 테스트 대비 변경점은 볼드와 밑줄로 표기했습니다.**</ins>
> 
> #### 테스트 대상
>
> "배송 가능한 의뢰 조회"(목록)는 배송원이 의뢰를 수락할 때 반드시 사용하는 핵심 기능으로 **가장 요청이 많아 응답시간과 TPS가 중요**합니다.
>
> #### 인스턴스 사양
>
> - `AWS RDS db.t4g.micro` - MySQL Community × 1
> - `AWS EC2 t2.micro` - Ubuntu × 6
>
> #### DB에 저장된 데이터
>
> - `order` 테이블 1,000만 건 (조회 대상: 100만 건(10%))
> - `user` 테이블: 20만 건 (1인 평균 `order` 50건)
>
> #### k6 부하 테스트 시나리오
>
> 스테이지
>
> 1. 4분 동안 가상 사용자 <ins>**1,000 → 1,800**</ins>명까지 증가
> 2. 2분 동안 가상 사용자 <ins>**1,000 → 1,800**</ins>명 유지
> 3. 20초 동안 가상 사용자 <ins>**200명까지 감소**</ins>
>
> 이러레이션
>
> - 이러레이션마다 10회 요청
> - 요청마다 1초 sleep, 다음 요청에는 페이지네이션 파라미터를 20씩 증가
> - 이터레이션 종료 시 페이지네이션 파라미터는 0으로 초기화

### 문제

<!-- - 누가
- 어디서
  - AWS환경에서
- 언제
  - 부하테스트를 할때
- 왜
  - RDS의 커넥션 풀 한계에 근접, cpu 사용율 70~80%임

- 무엇을
  - ec2 서버 인스턴스에서 커넥션 수 조절, 쿼리 튜닝이 필요함
- 어떻게
  - 필요한 커넥션 수에 대해 검증함 532순서로 줄였고 별 문제 없었음
  - 서버 8대로 확장했음, 커넥션풀은 안정적이고 타임아웃 발생안함
- 성과
  - TPS 높아짐, 타임아웃 발생 없앰, RDS 커넥션 수 줄임 -->

[2차 부하 테스트](<./2차 부하 테스트: 로드밸런서로 병렬 EC2 인스턴스를 구성해 CPU 사용률 20프로 감소, TPS 4배 증가.md>)에서 EC2 서버의 스케일 아웃으로 인해 `RDS db.t4g.micro`의 **CPU 사용률 70~80%, 커넥션이 60에 근접해 타임아웃이 발생**했습니다.

**개선 전: RDS CPU 사용률 (70~80%)**

![개선 전: RDS CPU 사용률 (70~80%)](<2 RDS 커넥션 풀 병목 발생/개선 전: RDS CPU 사용률 (70~80).png>)

### 선택

<!-- - 왜
  - CPU사용률과 커넥션 조절에서 타임아웃 발생부터 막아야한다고 생각해서 커넥션부터 조절했음
- 가정
  - EC2 서버의 커넥션 수는 기본값으로 10개인데 t2.micro에 과연 이만큼 필요한지 의문이었다.
- 검증
  - EC2 서버 인스턴스의 커넥션을 532으로 줄이고 테스트함
  - 결론: 커넥션 5 = 0.5s, 3 = 1s로 레이턴시가 길어졌으나 크게 신경쓸 정도는 아니였음
- 무엇을
  - ec2 t2.micro 서버 인스턴스의 커넥션 수를
- 어떻게
  - 커넥션 수를 10 -> 5로 축소, 서버 8대로 확장
- 성과
  - 1,000 -> 1,400 TPS로 높아짐, RDS 커넥션 한계로 인한 타임아웃 발생 없음 -->

RDS 커넥션이 한계에 도달하는 문제를 해결하기 위한 방법으로 추가 비용이 없는 **서버 커넥션 풀 축소**와 간단한 벙법인 **RDS 스케일 업**을 생각했는데, **서버의 기본 커넥션 풀 크기(10)가 EC2 서버에 적절한지 의문**이어서 이를 **검증하고 적용했습니다.**

### 가설/검증

`EC2 t2.micro`의 **적합한 커넥션 풀 크기가 10 미만이라 가정**했습니다. 이를 검증하고자 서버, RDS, k6를 각 1대씩 구성하고 부하 테스트를 진행했습니다.

**서버의 커넥션 풀 크기를 5 → 3 → 2로 줄여가며 성능을 측정**했습니다. 각 테스트마다 `EC2 t2.micro` 서버 인스턴스는 **CPU 사용률 90%이상을 유지**하며 아래와 같은 결과를 얻었고, **커넥션 풀 크기가 적을수록 응답 시간은 증가하고 TPS는 낮아졌으나 차이는 미미했습니다.**

> 최적의 커넥션 풀 크기를 효율적으로 찾기 위해 이진 탐색을 적용했습니다. (10 → 5 → 3 → 2)

- **커넥션 풀 크기 5개:** 최대 240TPS, **응답시간 0.5s**
- **커넥션 풀 크기 3개:** 최대 220TPS, **응답시간 0.8s**
- **커넥션 풀 크기 2개:** 최대 210TPS, **응답시간 1s**

**검증: 커넥션 5개일 때 (240TPS)**

![검증: 커넥션 5개일 때 (240TPS)](<3 RDS 커넥션 풀 병목 발생/검증: 커넥션 5개일 때 (240TPS).png>)

**검증: 커넥션 3개일 때 (220TPS)**

![검증: 커넥션 3개일 때 (220TPS)](<3 RDS 커넥션 풀 병목 발생/검증: 커넥션 3개일 때 (220TPS).png>)

**검증: 커넥션 2개일 때 (210TPS)**

![검증: 커넥션 2개일 때 (210TPS)](<3 RDS 커넥션 풀 병목 발생/검증: 커넥션 2개일 때 (210TPS).png>)

**검증: EC2 CPU 사용률 90%**

![검증: EC2 CPU 사용률 90%](<3 RDS 커넥션 풀 병목 발생/검증: EC2 CPU 사용률 90.png>)

### 해결

커넥션 풀을 3이나 2로 줄였을 때의 **0.8s 이상 응답 시간**은 **클라이언트 경험에 문제가 될 수 있었습니다.** 따라서 **RDS 부하와 응답 시간(0.5s)을 모두 만족시키는 커넥션 풀 5를 최종 선택했습니다.**

이 과정에서 `EC2 t2.micro` **서버 인스턴스를 6대에서 8대로 증설하고 커넥션 풀 크기를 10에서 5로 축소**한 결과, **타임아웃을 방지하고 최대 TPS를 1,000에서 1,400까지 향상**시켰습니다.

**해결: k6 부하 테스트 결과**

![해결: k6 부하 테스트 결과](<3 RDS 커넥션 풀 병목 해결/해결: k6 부하 테스트 결과.png>)
