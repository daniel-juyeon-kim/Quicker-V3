## 문제

[1차 쿼리튜닝](./불필요한%20join%20제거.md)으로 레이턴시를 **37257ms까지 단축했으나** 로깅, 외부 API가 같이 실행되기 위해서 **100ms 이하로 낮춰야 합니다.**

## 해결

아래 방법의 장단점을 비교한 결과, 페이지네이션이 가장 적합하다고 판단했습니다.

역정규화

- 장점
  - **join최소화** 가능
- 단점
  - 기존 테이블 구조 변경
  - `order`와 연관된 레포지토리 전면 수정
    - **일이 너무 커짐**

멀티 컬럼 인덱스

- 단점: 조건절이 `and`, `is null`, `!=` 연산이 있어 장점 없음

페이지네이션

- 장점
  - **I/O가 적고 빠름**
  - `plainToInstance`의 객체 변환 시간 단축 가능
- 단점
  - **API 요청 증가**

기존에 조회한 10만 건의 데이터는 전부 필요하지 않고 요청당 20건 이면(모바일 환경에서 2페이지) 충분하다고 생각했습니다.

### 1차 코드

join을 사용하면 `offset`, `limit`가 제대로 동작하지 않아 `skip`, `take`를 사용했습니다.

```ts
    /**
     * Sets OFFSET - selection offset.
     * NOTE that it may not work as you expect if you are using joins.
     * If you want to implement pagination, and you are having join in your query,
     * then use the skip method instead.
     */
    offset(offset?: number): this;
```

#### 코드 변경사항

```diff
// 중략

  @Transactional()
  async findAllMatchableOrderByWalletAddress(
    deliverPersonWalletAddress: string,
+   skipNumber: number = 0,
  ) {
    try {
      const deliveryPerson = await this.getManager().findOne(UserEntity, {
        select: { id: true },
        where: { walletAddress: deliverPersonWalletAddress },
      });

      if (!deliveryPerson) {
        throw new NotExistDataException(deliverPersonWalletAddress);
      }

      const matchableOrders = await this.getManager()
        .createQueryBuilder(OrderEntity, 'order')
        .where('order.requesterId != :deliveryPersonId', {
          deliveryPersonId: deliveryPerson.id,
        })
        .andWhere('order.deliveryPersonId is null')
+       .take(20)
+       .skip(skipNumber)
+       .orderBy('order.id', 'DESC')
        .leftJoin('order.product', 'product')
        .addSelect([
          'product.width',
          'product.length',
          'product.height',
          'product.weight',
        ])
        .leftJoin('order.transportation', 'transportation')
        .addSelect([
          'transportation.walking',
          'transportation.bicycle',
          'transportation.scooter',
          'transportation.bike',
          'transportation.car',
          'transportation.truck',
        ])
        .leftJoin('order.destination', 'destination')
        .addSelect(['destination.x', 'destination.y', 'destination.detail'])
        .leftJoin('order.departure', 'departure')
        .addSelect(['departure.x', 'departure.y', 'departure.detail'])
        .getMany();

      return plainToInstance(MatchableOrderDto, matchableOrders);
    } catch (error) {
      if (error instanceof NotExistDataException) {
        throw error;
      }
      throw new UnknownDataBaseException(error);
    }
  }

// 중략
```

#### 로그

```log
  // 중략

  // 2번 실행 시작

  console.log
    query: SELECT DISTINCT `distinctAlias`.`order_id` AS `ids_order_id`, `distinctAlias`.`order_id` FROM (SELECT `order`.`id` AS `order_id`, `order`.`detail` AS `order_detail`, `order`.`requesterId` AS `order_requesterId`, `order`.`deliveryPersonId` AS `order_deliveryPersonId`, `product`.`width` AS `product_width`, `product`.`length` AS `product_length`, `product`.`height` AS `product_height`, `product`.`weight` AS `product_weight`, `transportation`.`walking` AS `transportation_walking`, `transportation`.`bicycle` AS `transportation_bicycle`, `transportation`.`scooter` AS `transportation_scooter`, `transportation`.`bike` AS `transportation_bike`, `transportation`.`car` AS `transportation_car`, `transportation`.`truck` AS `transportation_truck`, `destination`.`x` AS `destination_x`, `destination`.`y` AS `destination_y`, `destination`.`detail` AS `destination_detail`, `departure`.`x` AS `departure_x`, `departure`.`y` AS `departure_y`, `departure`.`detail` AS `departure_detail` FROM `order` `order` LEFT JOIN `product` `product` ON `product`.`id`=`order`.`id`  LEFT JOIN `transportation` `transportation` ON `transportation`.`id`=`order`.`id`  LEFT JOIN `destination` `destination` ON `destination`.`id`=`order`.`id`  LEFT JOIN `departure` `departure` ON `departure`.`id`=`order`.`id` WHERE `order`.`requesterId` != ? AND `order`.`deliveryPersonId` is null) `distinctAlias` ORDER BY `distinctAlias`.`order_id` DESC, `order_id` ASC LIMIT 20 -- PARAMETERS: ["082deb21-66e0-443b-a96f-ff40ce5e2cf2"]

     at Function.logInfo (node_modules/src/platform/PlatformTools.ts:235:17)

  console.log
    query: SELECT `order`.`id` AS `order_id`, `order`.`detail` AS `order_detail`, `order`.`requesterId` AS `order_requesterId`, `order`.`deliveryPersonId` AS `order_deliveryPersonId`, `product`.`width` AS `product_width`, `product`.`length` AS `product_length`, `product`.`height` AS `product_height`, `product`.`weight` AS `product_weight`, `transportation`.`walking` AS `transportation_walking`, `transportation`.`bicycle` AS `transportation_bicycle`, `transportation`.`scooter` AS `transportation_scooter`, `transportation`.`bike` AS `transportation_bike`, `transportation`.`car` AS `transportation_car`, `transportation`.`truck` AS `transportation_truck`, `destination`.`x` AS `destination_x`, `destination`.`y` AS `destination_y`, `destination`.`detail` AS `destination_detail`, `departure`.`x` AS `departure_x`, `departure`.`y` AS `departure_y`, `departure`.`detail` AS `departure_detail` FROM `order` `order` LEFT JOIN `product` `product` ON `product`.`id`=`order`.`id`  LEFT JOIN `transportation` `transportation` ON `transportation`.`id`=`order`.`id`  LEFT JOIN `destination` `destination` ON `destination`.`id`=`order`.`id`  LEFT JOIN `departure` `departure` ON `departure`.`id`=`order`.`id` WHERE ( `order`.`requesterId` != ? AND `order`.`deliveryPersonId` is null ) AND ( `order`.`id` IN (999998, 999995, 999989, 999976, 999967, 999959, 999955, 999948, 999938, 999934, 999895, 999890, 999884, 999880, 999874, 999872, 999870, 999850, 999842, 999839) ) ORDER BY `order`.`id` DESC -- PARAMETERS: ["082deb21-66e0-443b-a96f-ff40ce5e2cf2"]

      at Function.logInfo (node_modules/src/platform/PlatformTools.ts:235:17)
  
  // 2번 실행 끝

  console.log
    의뢰 조회 소요시간: 39ms

      at OrderRepository.findAllMatchableOrderByWalletAddress (src/database/type-orm/repository/order/order.repository.ts:215:15)

  console.log
    클래스 객체 변환 소요시간: 3ms

      at OrderRepository.findAllMatchableOrderByWalletAddress (src/database/type-orm/repository/order/order.repository.ts:220:15)

  console.log
    query: COMMIT

      at Function.logInfo (node_modules/src/platform/PlatformTools.ts:235:17)

  console.log
    메서드 소요 시간: 94ms

      at order1.repository.test.ts:149:17
```

`take`, `skip`을 사용하고 위와 같이 쿼리가 2번 실행되었습니다. 이런 현상이 발생한 이유를 간략하게 설명하면 user와 order가 1:N 관계이고 join하면 아래와 같은 결과가 나옵니다.

| userId | orderId |
| :----: | :-----: |
|   1    |    1    |
|   1    |    2    |
|   1    |    3    |
|   2    |    4    |
|   2    |    5    |
|   3    |    6    |

이때 `LIMIT 3`으로 userId 별 orderId를 가져오려고 했으나, 아래와 같이 userId가 1인 레코드 3개만 조회됩니다.

| userId | orderId |
| :----: | :-----: |
|   1    |    1    |
|   1    |    2    |
|   1    |    3    |

TypeORM은 이런 문제를 피하고자 먼저 user 테이블의 id만 `LIMIT`과 `OFFSET`을 적용해 조회한 후, 그 id로 join 해 `order` 데이터를 가져옵니다. 이 과정에서 **쿼리가 2번 실행**됩니다.

### 2차 코드

위와 같은 문제로 서브쿼리를 사용해 통신 횟수를 줄이겠습니다.

```diff
  // 중략

  @Transactional()
  async findAllMatchableOrderByWalletAddress(
    deliverPersonWalletAddress: string,
    skipNumber: number = 0,
  ) {
    try {
      const deliveryPerson = await this.getManager().findOne(UserEntity, {
        select: { id: true },
        where: { walletAddress: deliverPersonWalletAddress },
      });

      if (!deliveryPerson) {
        throw new NotExistDataException(deliverPersonWalletAddress);
      }

      const matchableOrders = await this.getManager()
        .createQueryBuilder(OrderEntity, 'order')
-       .where('order.requesterId != :deliveryPersonId', {
-         deliveryPersonId: deliveryPerson.id,
-       })
-       .andWhere('order.deliveryPersonId is null')
+       .where((qb) => {
+         const subQuery = qb
+           .subQuery()
+           .select('sq_order.id')
+           .from(OrderEntity, 'sq_order')
+           .where('sq_order.requesterId != :deliveryPersonId', {
+             deliveryPersonId: deliveryPerson.id,
+           })
+           .andWhere('sq_order.deliveryPersonId is null')
+           .orderBy('sq_order.id', 'DESC')
+           .limit(20)
+           .offset(skipNumber)
+           .getQuery();
+
+         return 'order.id IN (SELECT * FROM' + subQuery + ' as t)';
+       })
-       .leftJoin('order.product', 'product')
+       .innerJoin('order.product', 'product')
        .addSelect([
          'product.width',
          'product.length',
          'product.height',
          'product.weight',
        ])
-       .leftJoin('order.transportation', 'transportation')
+       .innerJoin('order.transportation', 'transportation')
        .addSelect([
          'transportation.walking',
          'transportation.bicycle',
          'transportation.scooter',
          'transportation.bike',
          'transportation.car',
          'transportation.truck',
        ])
-       .leftJoin('order.destination', 'destination')
+       .innerJoin('order.destination', 'destination')
        .addSelect(['destination.x', 'destination.y', 'destination.detail'])
-       .leftJoin('order.departure', 'departure')
+       .innerJoin('order.departure', 'departure')
        .addSelect(['departure.x', 'departure.y', 'departure.detail'])
        .getMany();

      return plainToInstance(MatchableOrderDto, matchableOrders);
    } catch (error) {
      if (error instanceof NotExistDataException) {
        throw error;
      }
      throw new UnknownDataBaseException(error);
    }
  }

  // 중략
```

#### 로그

```log
  console.log
    query: SELECT VERSION() AS `version`

      at Function.logInfo (node_modules/src/platform/PlatformTools.ts:235:17)

  console.log
    query: START TRANSACTION

      at Function.logInfo (node_modules/src/platform/PlatformTools.ts:235:17)

  console.log
    query: SELECT `UserEntity`.`id` AS `UserEntity_id` FROM `user` `UserEntity` WHERE ((`UserEntity`.`walletAddress` = ?)) LIMIT 1 -- PARAMETERS: ["0x26d3d7cd73cd63e07feb92eaa9803aebbf9e6fd8"]

      at Function.logInfo (node_modules/src/platform/PlatformTools.ts:235:17)

  console.log
    사용자 조회 소요시간: 17ms

      at OrderRepository.findAllMatchableOrderByWalletAddress (src/database/type-orm/repository/order/order.repository.ts:176:15)

  console.log
    query: SELECT `order`.`id` AS `order_id`, `order`.`detail` AS `order_detail`, `order`.`requesterId` AS `order_requesterId`, `order`.`deliveryPersonId` AS `order_deliveryPersonId`, `product`.`width` AS `product_width`, `product`.`length` AS `product_length`, `product`.`height` AS `product_height`, `product`.`weight` AS `product_weight`, `product`.`id` AS `product_id`, `transportation`.`walking` AS `transportation_walking`, `transportation`.`bicycle` AS `transportation_bicycle`, `transportation`.`scooter` AS `transportation_scooter`, `transportation`.`bike` AS `transportation_bike`, `transportation`.`car` AS `transportation_car`, `transportation`.`truck` AS `transportation_truck`, `transportation`.`id` AS `transportation_id`, `destination`.`x` AS `destination_x`, `destination`.`y` AS `destination_y`, `destination`.`detail` AS `destination_detail`, `destination`.`id` AS `destination_id`, `departure`.`x` AS `departure_x`, `departure`.`y` AS `departure_y`, `departure`.`detail` AS `departure_detail`, `departure`.`id` AS `departure_id` FROM `order` `order` INNER JOIN `product` `product` ON `product`.`id`=`order`.`id`  INNER JOIN `transportation` `transportation` ON `transportation`.`id`=`order`.`id`  INNER JOIN `destination` `destination` ON `destination`.`id`=`order`.`id`  INNER JOIN `departure` `departure` ON `departure`.`id`=`order`.`id` WHERE `order`.`id` IN (SELECT * FROM(SELECT `sq_order`.`id` AS `sq_order_id` FROM `order` `sq_order` WHERE `sq_order`.`requesterId` != ? AND `sq_order`.`deliveryPersonId` is null ORDER BY `sq_order_id` DESC LIMIT 20) as t) -- PARAMETERS: ["082deb21-66e0-443b-a96f-ff40ce5e2cf2"]

      at Function.logInfo (node_modules/src/platform/PlatformTools.ts:235:17)

  console.log
    의뢰 조회 소요시간: 26ms

      at OrderRepository.findAllMatchableOrderByWalletAddress (src/database/type-orm/repository/order/order.repository.ts:224:15)

  console.log
    클래스 객체 변환 소요시간: 3ms

      at OrderRepository.findAllMatchableOrderByWalletAddress (src/database/type-orm/repository/order/order.repository.ts:229:15)

  console.log
    query: COMMIT

      at Function.logInfo (node_modules/src/platform/PlatformTools.ts:235:17)

  console.log
    메서드 소요 시간: 74ms

      at order1.repository.test.ts:149:17
```

#### explain

```log
id|select_type |table         |partitions|type  |possible_keys                                                |key                           |key_len|ref                    |rows  |filtered|Extra                           |
--+------------+--------------+----------+------+-------------------------------------------------------------+------------------------------+-------+-----------------------+------+--------+--------------------------------+
 1|PRIMARY     |<subquery2>   |          |ALL   |                                                             |                              |       |                       |      |   100.0|                                |
 1|PRIMARY     |order         |          |eq_ref|PRIMARY                                                      |PRIMARY                       |4      |<subquery2>.sq_order_id|     1|   100.0|                                |
 1|PRIMARY     |departure     |          |eq_ref|PRIMARY                                                      |PRIMARY                       |4      |<subquery2>.sq_order_id|     1|   100.0|                                |
 1|PRIMARY     |destination   |          |eq_ref|PRIMARY                                                      |PRIMARY                       |4      |<subquery2>.sq_order_id|     1|   100.0|                                |
 1|PRIMARY     |product       |          |eq_ref|PRIMARY                                                      |PRIMARY                       |4      |<subquery2>.sq_order_id|     1|   100.0|                                |
 1|PRIMARY     |transportation|          |eq_ref|PRIMARY                                                      |PRIMARY                       |4      |<subquery2>.sq_order_id|     1|   100.0|                                |
 2|MATERIALIZED|<derived3>    |          |ALL   |                                                             |                              |       |                       |    20|   100.0|                                |
 3|DERIVED     |sq_order      |          |ref   |FK_655a9bfe2ec449a8febb68c4136,FK_1e808bbe959a8807b2cce4a461f|FK_1e808bbe959a8807b2cce4a461f|1023   |const                  |211906|   55.54|Using where; Backward index scan|
```

#### explain analyze

```log
-> Nested loop inner join  (cost=30148 rows=20) (actual time=1.01..1.29 rows=20 loops=1)
    -> Nested loop inner join  (cost=30132 rows=20) (actual time=1.01..1.23 rows=20 loops=1)
        -> Nested loop inner join  (cost=30115 rows=20) (actual time=0.999..1.15 rows=20 loops=1)
            -> Nested loop inner join  (cost=30097 rows=20) (actual time=0.993..1.1 rows=20 loops=1)
                -> Nested loop inner join  (cost=30080 rows=20) (actual time=0.986..1.04 rows=20 loops=1)
                    -> Table scan on <subquery2>  (cost=30075..30077 rows=20) (actual time=0.97..0.972 rows=20 loops=1)
                        -> Materialize with deduplication  (cost=30075..30075 rows=20) (actual time=0.969..0.969 rows=20 loops=1)
                            -> Table scan on t  (cost=30070..30073 rows=20) (actual time=0.232..0.234 rows=20 loops=1)
                                -> Materialize  (cost=30070..30070 rows=20) (actual time=0.23..0.23 rows=20 loops=1)
                                    -> Limit: 20 row(s)  (cost=30068 rows=20) (actual time=0.205..0.214 rows=20 loops=1)
                                        -> Filter: ((sq_order.requesterId <> '082deb21-66e0-443b-a96f-ff40ce5e2cf2') and (sq_order.deliveryPersonId is null))  (cost=30068 rows=117693) (actual time=0.204..0.211 rows=20 loops=1)
                                            -> Index lookup on sq_order using FK_1e808bbe959a8807b2cce4a461f (deliveryPersonId=NULL) (reverse)  (cost=30068 rows=211906) (actual time=0.2..0.204 rows=20 loops=1)
                    -> Single-row index lookup on order using PRIMARY (id=`<subquery2>`.sq_order_id)  (cost=0.741 rows=1) (actual time=0.00304..0.00307 rows=1 loops=20)
                -> Single-row index lookup on departure using PRIMARY (id=`<subquery2>`.sq_order_id)  (cost=15.6 rows=1) (actual time=0.00258..0.00261 rows=1 loops=20)
            -> Single-row index lookup on destination using PRIMARY (id=`<subquery2>`.sq_order_id)  (cost=15.7 rows=1) (actual time=0.00238..0.00242 rows=1 loops=20)
        -> Single-row index lookup on product using PRIMARY (id=`<subquery2>`.sq_order_id)  (cost=14.7 rows=1) (actual time=0.00366..0.00369 rows=1 loops=20)
    -> Single-row index lookup on transportation using PRIMARY (id=`<subquery2>`.sq_order_id)  (cost=14.9 rows=1) (actual time=0.0029..0.00294 rows=1 loops=20)
```

### 성과

limit, offset으로 조회 건수를 **10만 → 20으로 줄이고 서브쿼리로 통신 횟수를 줄여, 필터링은 10433ms → 0.972ms, 쿼리는 27747ms → 1.29ms, 레포지토리 메서드는 37257ms → 74ms로 단축**했습니다.
